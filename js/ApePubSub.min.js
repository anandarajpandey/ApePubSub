/**
 * @author Pablo Tejada
 * @repo https://github.com/ptejada/ApePubSub
 * Built on 2013-07-08 @ 02:14
 */
function randomString(a,c){for(var e=c||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",d=a||32,b="",g=0;g<d;g++)var k=Math.floor(Math.random()*e.length),b=b+e.substring(k,k+1);return b}
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var c=Array.prototype.slice.call(arguments,1),e=this,d=function(){},b=function(){return e.apply(this instanceof d?this:a||window,c.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;b.prototype=new d;return b});
function APS(a,c,e){this.option={poll:25E3,debug:!1,session:!0,connectionArgs:{},server:a,transport:["ws","lp"],secure:!1,eventPush:!1,addFrequency:!0,autoUpdate:!0};this.identifier="APS";this.version="1.6.0";this.state=0;this._events={};this.chl=0;this.user={};this.pipes={};this.channels={};this.eQueue={};if(c)this.on(c);if(e)for(var d in e)this.option[d]=e[d];"Microsoft Internet Explorer"==navigator.appName&&(this.log="undefined"==typeof window.console?function(){}:function(){if(!1!=this.option.debug){var a=
Array.prototype.slice.call(arguments);a.unshift("["+this.identifier+"]");window.console.log(a.join().replace(",",""))}});this.session._client=this;return this}
APS.prototype.connect=function(a){var c=this.option.server,e={onmessage:this.onMessage.bind(this),onerror:function(a){this.trigger("dead",[a]);this.transport.close()}.bind(this)};if(1==this.state)return this.log("Already Connected!");var d="CONNECT";a=this.option.connectionArgs=a||this.option.connectionArgs;var b=this.session.restore();this.session.freq.change(parseInt(this.session.freq.value)+1);if(!0==this.option.session){if("object"==typeof b)a=b,d="RESTORE";else if(!1==this.trigger("connect"))return!1;
this.option.addFrequency&&(c=this.session.freq.value+"."+c)}else if(this.state=0,!1==this.trigger("connect"))return!1;this.transport?0==this.transport.state&&(this.transport=new APS.Transport(c,e,this)):this.transport=new APS.Transport(c,e,this);a.version=this.version;this.sendCmd(d,a);return this};APS.prototype.reconnect=function(){if(0<this.state&&0<this.transport.state)return this.log("Client already connected!");this.channels={};this.connect()};
APS.prototype.trigger=function(a,c){a=a.toLowerCase();c instanceof Array||(c=[c]);if("_client"in this)for(var e in this._client._events[a])if(this._client._events[a].hasOwnProperty(e)&&(this.log("{{{ "+a+" }}}["+e+"] on client ",this._client),!1===this._client._events[a][e].apply(this,c)))return!1;for(e in this._events[a])if(this._events[a].hasOwnProperty(e)&&(this._client?this.log("{{{ "+a+" }}}["+e+"] ",this):this.log("{{{ "+a+" }}}["+e+"] on client ",this),!1===this._events[a][e].apply(this,c)))return!1;
return!0};APS.prototype.on=function(a,c){var e=[];if("string"==typeof a&&"function"==typeof c)e[a]=c;else if("object"==typeof a)e=a;else return this.log("Wrong parameters passed to on() method"),!1;for(var d in e)e.hasOwnProperty(d)&&(c=e[d],d=d.toLowerCase(),this._events[d]||(this._events[d]=[]),this._events[d].push(c));return this};APS.prototype.getPipe=function(a){return"string"==typeof a?this.pipes[a]:this.pipes[a.pubid]};
APS.prototype.send=function(a,c,e,d,b){this.sendCmd("Event",{event:c,data:e,sync:d},a,b);return this};
APS.prototype.sendCmd=function(a,c,e,d){var b={CONNECT:0,RESTORE:0};if(1==this.state||a in b){b={cmd:a,chl:this.chl,freq:this.session.freq.value};c&&(b.params=c);e&&(b.params.pipe="string"==typeof e?e:e.pubid);this.session.id&&(b.sessid=this.session.id);this.log("<<<< ",a.toUpperCase()," >>>> ",b);"function"!=typeof d&&(d=function(){});a=[];try{a=JSON.stringify([b])}catch(g){this.log(g),this.log("Data Could not be strigify:",a),this.quit()}"pushed"!=this.transport.send(a,d,b)&&this.session.saveChl()}else this.on("ready",
this.sendCmd.bind(this,a,c));return this};APS.prototype.poll=function(){0==this.transport.id&&(clearTimeout(this.poller),this.poller=setTimeout(this.check.bind(this),this.option.poll))};APS.prototype.check=function(a){if(0==this.transport.id||a)this.sendCmd("CHECK"),this.poll()};APS.prototype.quit=function(){this.sendCmd("QUIT");this.transport.close();this.trigger("dead");this.session.destroy();this.state=0};
APS.prototype.sub=function(a,c,e){if("object"==typeof c)if("object"==typeof a)for(var d in a)this.onChannel(a[d],c);else this.onChannel(a,c);if("function"==typeof e)if("object"==typeof a)for(d in a)this.onChannel(a[d],"joined",e);else this.onChannel(a,"joined",e);if(0==this.state)this.on("ready",this.sub.bind(this,a)),this.connect({user:this.user});else if("string"==typeof a)a=a.toLowerCase(),"object"!=typeof this.channels[a]?this.sendCmd("JOIN",{channels:[a]}):this.log("User already subscribed to ["+
a+"]");else{c=[];for(var b in a)"object"!=typeof this.channels[a[b].toLowerCase()]&&c.push(a[b]);0<c.length&&this.sendCmd("JOIN",{channels:c})}return this};APS.prototype.pub=function(a,c,e,d){var b=this.getChannel(a);b||32!=a.length||(b=this.getPipe(a));b?(a="string"==typeof c?"message":"data","message"==a&&(c=encodeURIComponent(c)),b.send(a,c,e,d)):this.log("NO Channel "+a)};APS.prototype.getChannel=function(a){a=a.toLowerCase();return a in this.channels?this.channels[a]:!1};
APS.prototype.onChannel=function(a,c,e){a=a.toLowerCase();if(a in this.channels)return this.channels[a].on(c,e);if("object"==typeof c){"object"!=typeof this.eQueue[a]&&(this.eQueue[a]=[]);for(var d in c)e=c[d],this.eQueue[a].push([d,e]),this.log("Adding ["+a+"] event '"+d+"' to queue")}else d={},d[c]=e,this.onChannel(a,d)};APS.prototype.unSub=function(a){""!=a&&this.getChannel(a).leave()};
"Microsoft Internet Explorer"!=navigator.appName&&(APS.prototype.log=function(){if(this.option.debug){var a=Array.prototype.slice.call(arguments);a.unshift("["+this.identifier+"]");window.console.log.apply(console,a)}});
APS.prototype.onMessage=function(a){try{a=JSON.parse(a)}catch(c){a=a.replace(/\\'/g,"'");try{a=JSON.parse(a)}catch(e){return e.type="close",this.trigger("dead",[e]),this.transport.close()}}var d,b,g=!1,k=!0,h;for(h in a)if(a.hasOwnProperty(h))switch(d=a[h].raw,b=a[h].data,this.log(">>>> ",d," <<<< ",b),d){case "LOGIN":k=!1;this.state=0==this.state?1:this.state;this.session.id=b.sessid;this.trigger("login",[b.sessid]);break;case "IDENT":var k=!1,g=!0,f=new APS.CUser(b.user,this);this.user=this.pipes[f.pubid]=
f;1==this.state&&this.trigger("ready");this.session.save();break;case "CHANNEL":d=new APS.Channel(b.pipe,this);this.pipes[d.pubid]=d;this.channels[d.name]=d;if(b=b.users)for(h=0;h<b.length;h++)d.addUser(b[h]);b=d.name.toLowerCase();if("object"==typeof this.eQueue[b]){b=this.eQueue[b];var l;for(h in b)b.hasOwnProperty(h)&&(f=b[h][0],l=b[h][1],d.on(f,l))}d.trigger("joined",[this.user,d]);this.trigger("newChannel",[d]);break;case "SYNC":f=this.user;d=this.pipes[b.chanid];"message"==b.event&&(b.data=
decodeURIComponent(b.data));d instanceof APS.User?f.trigger(b.event,[b.data,f,d]):d.trigger(b.event,[b.data,f,d]);break;case "EVENT-X":d=this.pipes[b.pipe.pubid];d.trigger(b.event,[b.data,d,d]);break;case "EVENT":f=this.pipes[b.from.pubid];"undefined"==typeof f&&b.from&&(client.pipe[b.from.pubid]=new APS.User(b.from,client),f=client.pipe[b.from.pubid]);d=this.pipes[b.pipe.pubid];d.pubid==f.pubid&&(d=this.user);"message"==b.event&&(b.data=decodeURIComponent(b.data));d.trigger(b.event,[b.data,f,d]);
break;case "NOJOIN":this.trigger("notjoined",[b]);break;case "JOIN":d=this.pipes[b.pipe.pubid];f=d.addUser(b.user);d.trigger("join",[f,d]);break;case "LEFT":d=this.pipes[b.pipe.pubid];f=this.pipes[b.user.pubid];delete d.users[b.user.pubid];d.trigger("left",[f,d]);break;case "UPDATE":this.option.autoUpdate&&(d=this.pipes[b.pipe.pubid],d.update(b.pipe.properties));break;case "CLOSE":k=!1;break;case "ERR":k=!1;f=[b.code,b.value,b];switch(b.code){case "001":case "002":case "003":clearTimeout(this.poller);
this.trigger("dead",f);break;case "004":case "250":this.state=0;this.session.destroy(!0);this.option.session&&this.reconnect();break;default:this.check()}this.trigger("error",f);this.trigger("error"+b.code,f);break;default:f=[];for(h in b)b.hasOwnProperty(h)&&f.push(b[h]);this.trigger("raw"+d,f)}g&&1!=this.state&&(k=!0,this.state=1,!1!==this.trigger("restored")&&this.trigger("ready"));0==this.transport.id&&(k&&1==this.transport.state)&&this.check()};
APS.Transport=function(a,c,e){this.state=0;this.stack=[];this.callback=c;var d=e.option.transport,b=Array.prototype.slice.call(arguments);if("object"==typeof d)for(var g in d){if(!1!=APS.Transport[d[g]].apply(this,b))break}else"string"==typeof d&&APS.Transport[d].apply(this,b);var k=new function(){if("XMLHttpRequest"in window)return XMLHttpRequest;if("ActiveXObject"in window){var a=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],d;for(d in a)try{return ActiveXObject(a[d])}catch(b){}}return!1};
this.request=function(a,d,b){var c=new k;c.addEventListener("load",function(){b(this.responseText)},!1);c.open("POST",a,!0);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.send(d)};if(e.option.eventPush){var h=this.send.bind(this),f=function(a){c.onmessage(a)};this.send=function(a,d,b){if("Event"==b.cmd)return this.request(e.option.eventPush,"cmd="+a,f),"pushed";h.apply(this,[a,d])}}};
APS.Transport.ws=APS.Transport.wb=function(a,c,e){if("WebSocket"in window){this.id=6;this.loop=setInterval(e.check.bind(e,!0),3E4);var d=e.option.secure?"wss":"ws";try{var b=new WebSocket(d+"://"+a+"/6/")}catch(g){return c.onerror(g),!1}if(void 0===b.url)return!1;this.send=function(a,d){0<this.state?b.send(a):this.stack.push(a);"function"==typeof d&&d()}.bind(this);b.onerror=function(a){this.state=0;clearInterval(this.loop);c.onerror(a)}.bind(this);b.onopen=function(){this.state=2;for(var a=0;a<this.stack.length;a++)this.send(this.stack[a],
null,JSON.parse(this.stack[a])[0]);this.stack=[]}.bind(this);b.onmessage=function(a){c.onmessage(a.data)};b.onclose=function(a){clearInterval(this.loop);this.state=e.state=0;c.onerror(a)}.bind(this);this.close=function(){b.close();this.state=e.state=0}}else return e.log("No Websocket support"),!1};
APS.Transport.lp=function(a,c,e){function d(d){d.origin==k+"://"+a&&d.source===g.contentWindow&&(this.state=1,this.callback.onmessage(d.data))}function b(){this.state=1;for(var a=0;a<this.stack.length;a++)this.send(this.stack[a],null,JSON.parse(this.stack[a])[0]);this.stack=[]}this.id=0;var g=document.createElement("iframe"),k=e.option.secure?"https":"http";c=window.location.protocol+"//"+window.location.host;a=a.toLowerCase();g.style.display="none";document.body.appendChild(g);g.setAttribute("src",
k+"://"+a+'/?[{"cmd":"frame","params": {"origin":"'+c+'"}}]');"addEventListener"in window?(window.addEventListener("message",d.bind(this),0),g.addEventListener("load",b.bind(this),0)):window.attachEvent("onmessage",d.bind(this));this.send=function(d,b){0<this.state?(g.contentWindow.postMessage(d,k+"://"+a),this.state=2):this.stack.push(d);"function"==typeof b&&b()};this.close=function(){clearTimeout(e.poller);e.state=0}};
APS.User=function(a,c){Object.defineProperties(this,{update:{value:function(a,b){if(!a)return!1;b||(a._rev=parseInt(a._rev));if(a._rev>this._rev||b)for(var e in a)this[e]!=a[e]&&(this[e]=a[e],c.trigger("user"+e+"Update",[a[e],this]),c.trigger("userUpdate",[e,a[e],this]))}},_rev:{value:null,configurable:!0,writable:!0},channels:{value:{},writable:!0},pubid:{value:a.pubid},pub:{value:c.pub.bind(c,a.pubid)},send:{value:c.send.bind(c,a.pubid)}});for(var e in a.properties)this[e]=a.properties[e]};
APS.CUser=function(a,c){Object.defineProperties(this,{update:{value:function(a,b){if(!a)return!1;b||(a._rev=parseInt(a._rev));if(a._rev>this._rev||b)for(var c in a)this[c]!=a[c]&&(this[c]=a[c],this.trigger("user"+c+"Update",[a[c],this]),this.trigger("userUpdate",[c,a[c],this]))}},change:{value:function(a,b){if("object"==typeof a)var c=a;else c={},c[a]=b;this.update(c,!0);this._client.sendCmd("userPropUpdate",c)}},_rev:{value:null,configurable:!0,writable:!0},_events:{value:{},writable:!0},_client:{value:c},
pubid:{value:a.pubid},channels:{value:{},writable:!0},on:{value:c.on.bind(this)},trigger:{value:c.trigger.bind(this)},log:{value:c.log.bind(c,"[CurrentUser]")}});for(var e in a.properties)this[e]=a.properties[e]};
APS.Channel=function(a,c){Object.defineProperties(this,{update:{value:function(a){if(!a)return!1;a._rev=parseInt(a._rev);if(a._rev>this._rev)for(var b in a)this[b]!=a[b]&&(this[b]=a[b],this.trigger("user"+b+"Update",[a[b],this]),this.trigger("userUpdate",[b,a[b],this]))}},leave:{value:function(){this.trigger("unsub",[c.user,this]);c.sendCmd("LEFT",{channel:a.properties.name});this.log("Unsubscribed");delete c.channels[this.name];delete c.eQueue[this.name]}},_rev:{value:null,configurable:!0,writable:!0},
_events:{value:{},writable:!0},_client:{value:c},pubid:{value:a.pubid},users:{value:{},writable:!0},on:{value:c.on.bind(this)},trigger:{value:c.trigger.bind(this)},log:{value:c.log.bind(c,"[channel]","["+a.properties.name+"]")}});for(var e in a.properties)this[e]=a.properties[e];0!==this.name.indexOf("*")&&Object.defineProperties(this,{users:{value:{},writable:!0},addUser:{value:function(a){var b=c.getPipe(a.pubid);b?c.option.autoUpdate&&b.update(a.properties):(c.pipes[a.pubid]=new APS.User(a,c),
b=c.pipes[a.pubid],b.channels[b.pubid]=b);b.channels[this.name]=this;return this.users[a.pubid]=b}},send:{value:c.send.bind(c,this.pubid)},pub:{value:c.pub.bind(c,this.name)}})};
APS.prototype.session={id:"",chl:{},_client:{},cookie:{},freq:{},data:{},save:function(){this._client.option.session&&(this.cookie.change(this.id+":"+this._client.user.pubid),this.saveChl())},saveChl:function(){this._client.option.session&&(this._client.chl++,this.chl.change(this._client.chl))},destroy:function(a){this._client.option.session&&(this.cookie.destroy(),this.chl.destroy(),a||this.freq.change(0),this._client.chl=0,this.id=null,this.properties={})},get:function(a){return this.data[a]},set:function(a,
c){this.data[a]=c},restore:function(){var a=this._client;this.chl=new APS.cookie(a.identifier+"_chl");this.cookie=new APS.cookie(a.identifier+"_session");this.freq=new APS.cookie(a.identifier+"_frequency");a.chl=this.chl.value||0;this.freq.value||this.freq.change("0");if("string"==typeof this.cookie.value&&32<=this.cookie.value.length){var c=this.cookie.value.split(":");this.id=c[0]}else return!1;a.state=2;return{sid:c[0],pubid:c[1]}}};
APS.cookie=function(a,c,e){this.change=function(a,c){var d=this.name;if(c){var e=new Date;e.setTime(e.getTime()+864E5*c);e="; expires="+e.toGMTString()}else e="";document.cookie=d+"="+a+e+"; path="+this.path;this.value=a};this.read=function(a){a+="=";for(var c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(a))return e.substring(a.length,e.length)}return null};this.destroy=function(){this.change("",-1)};this.path="/";var d=
this.read(a);this.name=a;d&&"undefined"==typeof c?this.value=d:(this.value=c||"",this.change(this.value,e));return this};
