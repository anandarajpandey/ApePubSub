/**
 * @author Pablo Tejada
 * @repo https://github.com/ptejada/ApePubSub
 * @version 1.6.2
 * Built on 2013-10-20 @ 07:06
 */
function randomString(a,d){for(var e=d||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",c=a||32,b="",f=0;f<c;f++)var h=Math.floor(Math.random()*e.length),b=b+e.substring(h,h+1);return b}
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var d=Array.prototype.slice.call(arguments,1),e=this,c=function(){},b=function(){return e.apply(this instanceof c?this:a||window,d.concat(Array.prototype.slice.call(arguments)))};c.prototype=this.prototype;b.prototype=new c;return b});
function APS(a,d,e){this.option={poll:25E3,debug:!1,session:!0,connectionArgs:{},server:a,transport:["ws","lp"],secure:!1,eventPush:!1,addFrequency:!0,autoUpdate:!0};this.identifier="APS";this.version="1.6.2";this.state=0;this._events={};this.user={};this.pipes={};this.channels={};this.eQueue={};if(d)this.on(d);if(e)for(var c in e)this.option[c]=e[c];"Microsoft Internet Explorer"==navigator.appName&&(this.log="undefined"==typeof window.console?function(){}:function(){if(!1!=this.option.debug){var b=
Array.prototype.slice.call(arguments);b.unshift("["+this.identifier+"]");window.console.log(b.join().replace(",",""))}});this.session=new APS.Session(this);return this}
APS.prototype.connect=function(a){var d=this.option.server,e={onmessage:this.onMessage.bind(this),onerror:function(b){this.trigger("dead",[b]);this.transport.close()}.bind(this)};if(1==this.state)return this.log("Already Connected!");var c="CONNECT";a=this.option.connectionArgs=a||this.option.connectionArgs;var b=this.session.restore();this.session.saveFreq();if(!0==this.option.session)if("object"==typeof b)a=b,c="RESTORE";else{if(!1==this.trigger("connect"))return!1}else if(this.state=0,!1==this.trigger("connect"))return!1;
this.option.addFrequency&&(d=this.session.getFreq()+"."+d);this.transport?0==this.transport.state&&(this.transport=new APS.Transport(d,e,this)):this.transport=new APS.Transport(d,e,this);a.version=this.version;this.sendCmd(c,a);return this};APS.prototype.reconnect=function(){if(0<this.state&&0<this.transport.state)return this.log("Client already connected!");this.channels={};this.connect()};
APS.prototype.trigger=function(a,d){a=a.toLowerCase();d instanceof Array||(d=[d]);if("_client"in this)for(var e in this._client._events[a])if(this._client._events[a].hasOwnProperty(e)&&(this.log("{{{ "+a+" }}}["+e+"] on client ",this._client),!1===this._client._events[a][e].apply(this,d)))return!1;for(e in this._events[a])if(this._events[a].hasOwnProperty(e)&&(this._client?this.log("{{{ "+a+" }}}["+e+"] ",this):this.log("{{{ "+a+" }}}["+e+"] on client ",this),!1===this._events[a][e].apply(this,d)))return!1;
return!0};APS.prototype.on=function(a,d){var e=[];if("string"==typeof a&&"function"==typeof d)e[a]=d;else if("object"==typeof a)e=a;else return this.log("Wrong parameters passed to on() method"),!1;for(var c in e)e.hasOwnProperty(c)&&(d=e[c],c=c.toLowerCase(),this._events[c]||(this._events[c]=[]),this._events[c].push(d));return this};APS.prototype.getPipe=function(a){return a in this.pipes?this.pipes[a]:!1};APS.prototype.send=function(a,d,e,c,b){this.sendCmd("Event",{event:d,data:e,sync:c},a,b);return this};
APS.prototype.sendCmd=function(a,d,e,c){var b={CONNECT:0,RESTORE:0};if(1==this.state||a in b){b={cmd:a,chl:this.transport.chl,freq:this.session.getFreq()};d&&(b.params=d);e&&(b.params.pipe="string"==typeof e?e:e.pubid);this.session.getID()&&(b.sessid=this.session.getID());this.log("<<<< ",a.toUpperCase()," >>>> ",b);"function"!=typeof c&&(c=function(){});a=[];try{a=JSON.stringify([b])}catch(f){this.log(f),this.log("Data Could not be strigify:",a),this.quit()}"pushed"!=this.transport.send(a,c,b)&&
this.transport.chl++}else this.on("ready",this.sendCmd.bind(this,a,d));return this};APS.prototype.poll=function(){0==this.transport.id&&(clearTimeout(this.poller),this.poller=setTimeout(this.check.bind(this),this.option.poll))};APS.prototype.check=function(a){if(0==this.transport.id||a)this.sendCmd("CHECK"),this.poll()};APS.prototype.quit=function(){this.sendCmd("QUIT");this.transport.close();this.trigger("dead");this.session.destroy();this.state=0};
APS.prototype.sub=function(a,d,e){if("object"==typeof d)if("object"==typeof a)for(var c in a)this.onChannel(a[c],d);else this.onChannel(a,d);if("function"==typeof e)if("object"==typeof a)for(c in a)this.onChannel(a[c],"joined",e);else this.onChannel(a,"joined",e);if(0==this.state)this.on("ready",this.sub.bind(this,a)),this.connect({user:this.user});else if("string"==typeof a)a=a.toLowerCase(),"object"!=typeof this.channels[a]?this.sendCmd("JOIN",{channels:[a]}):this.log("User already subscribed to ["+
a+"]");else{d=[];for(var b in a)"object"!=typeof this.channels[a[b].toLowerCase()]&&d.push(a[b]);0<d.length&&this.sendCmd("JOIN",{channels:d})}return this};APS.prototype.subscribe=APS.prototype.sub;APS.prototype.pub=function(a,d,e,c){var b=this.getChannel(a);b||32!=a.length||(b=this.getPipe(a));b?(a="string"==typeof d?"message":"data","message"==a&&(d=encodeURIComponent(d)),b.send(a,d,e,c)):this.log("NO Channel "+a)};APS.prototype.publish=APS.prototype.pub;
APS.prototype.getChannel=function(a){a=a.toLowerCase();return a in this.channels?this.channels[a]:!1};APS.prototype.onChannel=function(a,d,e){a=a.toLowerCase();if(a in this.channels)this.channels[a].on(d,e);else if("object"==typeof d){"object"!=typeof this.eQueue[a]&&(this.eQueue[a]=[]);for(var c in d)e=d[c],this.eQueue[a].push([c,e]),this.log("Adding ["+a+"] event '"+c+"' to queue")}else c={},c[d]=e,this.onChannel(a,c)};APS.prototype.unSub=function(a){""!=a&&this.getChannel(a).leave()};
APS.prototype.unSubscribe=APS.prototype.unSub;"Microsoft Internet Explorer"!=navigator.appName&&(APS.prototype.log=function(){if(this.option.debug){var a=Array.prototype.slice.call(arguments);a.unshift("["+this.identifier+"]");window.console.log.apply(console,a)}});
APS.prototype.onMessage=function(a){try{a=JSON.parse(a)}catch(d){a=a.replace(/\\'/g,"'");try{a=JSON.parse(a)}catch(e){return e.type="close",this.trigger("dead",[e]),this.transport.close()}}var c,b,f,h=!1,k=!0,g;for(g in a)if(a.hasOwnProperty(g))switch(c=a[g].raw,b=a[g].data,this.log(">>>> ",c," <<<< ",b),c){case "LOGIN":k=!1;this.state=0==this.state?1:this.state;this.session.save(b.sessid);this.trigger("login",[b.sessid]);break;case "IDENT":k=!1;h=!0;f=new APS.CUser(b.user,this);this.user=this.pipes[f.pubid]=
f;1==this.state&&this.trigger("ready");break;case "CHANNEL":c=new APS.Channel(b.pipe,this);this.pipes[c.pubid]=c;this.channels[c.name]=c;if(b=b.users)for(g=0;g<b.length;g++)c.addUser(b[g]);b=c.name.toLowerCase();if("object"==typeof this.eQueue[b]){b=this.eQueue[b];var l;for(g in b)b.hasOwnProperty(g)&&(f=b[g][0],l=b[g][1],c.on(f,l))}c.trigger("joined",[this.user,c]);this.trigger("newChannel",[c]);break;case "SYNC":f=this.user;c=this.pipes[b.chanid];"message"==b.event&&(b.data=decodeURIComponent(b.data));
c instanceof APS.User?f.trigger(b.event,[b.data,f,c]):c.trigger(b.event,[b.data,f,c]);break;case "EVENT-X":c=this.pipes[b.pipe.pubid];c.trigger(b.event,[b.data,c,c]);break;case "EVENT":f=this.pipes[b.from.pubid];"undefined"==typeof f&&b.from&&(client.pipe[b.from.pubid]=new APS.User(b.from,client),f=client.pipe[b.from.pubid]);c=this.pipes[b.pipe.pubid];c.pubid==f.pubid&&(c=this.user);"message"==b.event&&(b.data=decodeURIComponent(b.data));c.trigger(b.event,[b.data,f,c]);break;case "NOJOIN":this.trigger("notjoined",
[b]);break;case "JOIN":c=this.pipes[b.pipe.pubid];f=c.addUser(b.user);c.trigger("join",[f,c]);break;case "LEFT":c=this.pipes[b.pipe.pubid];f=this.pipes[b.user.pubid];delete c.users[b.user.pubid];c.trigger("left",[f,c]);break;case "UPDATE":this.option.autoUpdate&&(c=this.pipes[b.pipe.pubid],c._update(b.pipe.properties));break;case "SESSION_UPDATE":this.session._update(b);break;case "CLOSE":k=!1;break;case "ERR":k=!1;f=[b.code,b.value,b];switch(b.code){case "001":case "002":case "003":clearTimeout(this.poller);
this.trigger("dead",f);break;case "004":case "250":this.state=0;this.session.destroy(!0);this.option.session&&this.reconnect();break;default:this.check()}this.trigger("error",f);this.trigger("error"+b.code,f);break;default:f=[];for(g in b)b.hasOwnProperty(g)&&f.push(b[g]);this.trigger("raw"+c,f)}h&&1!=this.state&&(k=!0,this.state=1,!1!==this.trigger("restored")&&this.trigger("ready"));0==this.transport.id&&k&&1==this.transport.state&&this.check()};
APS.Transport=function(a,d,e){this.state=0;this.stack=[];this.callback=d;this.chl=0;var c=e.option.transport,b=Array.prototype.slice.call(arguments);if("object"==typeof c)for(var f in c){if(!1!=APS.Transport[c[f]].apply(this,b))break}else"string"==typeof c&&APS.Transport[c].apply(this,b);var h=new function(){if("XMLHttpRequest"in window)return XMLHttpRequest;if("ActiveXObject"in window){var b=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],a;for(a in b)try{return ActiveXObject(b[a])}catch(d){}}return!1};
this.request=function(b,a,d){var c=new h;c.addEventListener("load",function(){d(this.responseText)},!1);c.open("POST",b,!0);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.send(a)};if(e.option.eventPush){var k=this.send.bind(this),g=function(b){d.onmessage(b)};this.send=function(b,a,c){if("Event"==c.cmd)return this.request(e.option.eventPush,"cmd="+b,g),"pushed";k.apply(this,[b,a])}}};
APS.Transport.ws=APS.Transport.wb=function(a,d,e){if("WebSocket"in window){this.id=6;this.loop=setInterval(e.check.bind(e,!0),3E4);var c=e.option.secure?"wss":"ws";try{var b=new WebSocket(c+"://"+a+"/6/")}catch(f){return d.onerror(f),!1}if(void 0===b.url)return!1;this.send=function(a,c){0<this.state?b.send(a):this.stack.push(a);"function"==typeof c&&c()}.bind(this);b.onerror=function(b){this.state=0;clearInterval(this.loop);d.onerror(b)}.bind(this);b.onopen=function(){this.state=2;for(var b=0;b<this.stack.length;b++)this.send(this.stack[b],
null,JSON.parse(this.stack[b])[0]);this.stack=[]}.bind(this);b.onmessage=function(b){d.onmessage(b.data)};b.onclose=function(b){clearInterval(this.loop);this.state=e.state=0;d.onerror(b)}.bind(this);this.close=function(){b.close();this.state=e.state=0}}else return e.log("No Websocket support"),!1};
APS.Transport.lp=function(a,d,e){function c(b){b.origin==h+"://"+a&&b.source===f.contentWindow&&(this.state=1,this.callback.onmessage(b.data))}function b(){this.state=1;for(var b=0;b<this.stack.length;b++)this.send(this.stack[b],null,JSON.parse(this.stack[b])[0]);this.stack=[]}this.id=0;var f=document.createElement("iframe"),h=e.option.secure?"https":"http";d=window.location.protocol+"//"+window.location.host;a=a.toLowerCase();f.style.display="none";document.body.appendChild(f);f.setAttribute("src",
h+"://"+a+'/?[{"cmd":"frame","params": {"origin":"'+d+'"}}]');"addEventListener"in window?(window.addEventListener("message",c.bind(this),0),f.addEventListener("load",b.bind(this),0)):window.attachEvent("onmessage",c.bind(this));this.send=function(b,c){0<this.state?(f.contentWindow.postMessage(b,h+"://"+a),this.state=2):this.stack.push(b);"function"==typeof c&&c()};this.close=function(){clearTimeout(e.poller);e.state=0}};
APS.User=function(a,d){Object.defineProperties(this,{_update:{value:function(c){if(c&&(c._rev=parseInt(c._rev),c._rev>this._rev))for(var b in c)this[b]!=c[b]&&(this[b]=c[b],d.trigger("user"+b+"Update",[c[b],this]),d.trigger("userUpdate",[b,c[b],this]))}},_rev:{value:null,configurable:!0,writable:!0},channels:{value:{},writable:!0},pubid:{value:a.pubid},pub:{value:d.pub.bind(d,a.pubid)},publish:{value:d.pub.bind(d,a.pubid)},send:{value:d.send.bind(d,a.pubid)}});for(var e in a.properties)this[e]=a.properties[e]};
APS.CUser=function(a,d){Object.defineProperties(this,{_update:{value:function(c,b){if(c&&(b||(c._rev=parseInt(c._rev)),c._rev>this._rev||b))for(var a in c)this[a]!=c[a]&&(this[a]=c[a],this.trigger("user"+a+"Update",[c[a],this]),this.trigger("userUpdate",[a,c[a],this]))}},update:{value:function(a,b){if("object"==typeof a)var d=a;else d={},d[a]=b;this._update(d,!0);this._client.sendCmd("userPropUpdate",d)}},_rev:{value:null,configurable:!0,writable:!0},_events:{value:{},writable:!0},_client:{value:d},
pubid:{value:a.pubid},channels:{value:{},writable:!0},on:{value:d.on.bind(this)},trigger:{value:d.trigger.bind(this)},log:{value:d.log.bind(d,"[CurrentUser]")}});for(var e in a.properties)this[e]=a.properties[e]};
APS.Channel=function(a,d){Object.defineProperties(this,{_update:{value:function(a){if(a&&(a._rev=parseInt(a._rev),a._rev>this._rev))for(var b in a)this[b]!=a[b]&&(this[b]=a[b],this.trigger("channel"+b+"Update",[a[b],this]),this.trigger("channelUpdate",[b,a[b],this]))}},leave:{value:function(){this.trigger("unsub",[d.user,this]);d.sendCmd("LEFT",{channel:a.properties.name});this.log("Unsubscribed");delete d.channels[this.name];delete d.eQueue[this.name]}},_rev:{value:null,configurable:!0,writable:!0},
_events:{value:{},writable:!0},_client:{value:d},pubid:{value:a.pubid},on:{value:d.on.bind(this)},trigger:{value:d.trigger.bind(this)},log:{value:d.log.bind(d,"[channel]","["+a.properties.name+"]")}});for(var e in a.properties)this[e]=a.properties[e];0!==this.name.indexOf("*")&&Object.defineProperties(this,{users:{value:{},writable:!0},addUser:{value:function(a){var b=d.getPipe(a.pubid);b?d.option.autoUpdate&&b._update(a.properties):(d.pipes[a.pubid]=new APS.User(a,d),b=d.pipes[a.pubid],b.channels[b.pubid]=
b);b.channels[this.name]=this;return this.users[a.pubid]=b}},send:{value:d.send.bind(d,this.pubid)},pub:{value:d.pub.bind(d,this.name)},publish:{value:d.pub.bind(d,this.name)}})};
APS.Session=function(a){this._client=a;this._data={};this.store=new APS.Store(a.identifier+"_");this.getID=function(){return this._client.option.session?this.store.get("sid"):this.id};this.getFreq=function(){return this.store.get("freq")};this.getChl=function(){return this.store.get("chl")};this.save=function(a){this._client.option.session?this.store.set("sid",a):this.id=a};this.saveFreq=function(){var a=parseInt(this.store.get("freq")||0);this.store.set("freq",++a)};this.destroy=function(a){this.store.remove("sid");
this.store.remove("chl");a||this.store.set("freq",0);this._data={}};this.get=function(a){return this._data[a]};this.set=function(a,e){var c={};"object"==typeof a?c=a:c[a]=e;this._client.sendCmd("SESSION_SET",c);this._update(c)};this._update=function(a){for(var e in a)this._data[e]=a[e]};this.restore=function(){var a=this._client;this.store.get("freq")||this.store.set("freq","0");var e=this.store.get("sid");if("string"!=typeof e||32!==e.length)return!1;a.state=2;return{sid:e}}};
APS.Store=function(a){"undefined"==typeof a&&(a="");"Storage"in window?(this.get=function(d){d=a+d;return localStorage.getItem(d)},this.set=function(d,e){d=a+d;localStorage.setItem(d,e)},this.remove=function(d){d=a+d;localStorage.removeItem(d)}):(this.get=function(d){d=a+d;d+="=";for(var e=document.cookie.split(";"),c=0;c<e.length;c++){for(var b=e[c];" "==b.charAt(0);)b=b.substring(1,b.length);if(0==b.indexOf(d))return b.substring(d.length,b.length)}return null},this.set=function(d,e){d=a+d;document.cookie=
d+"="+e+"; path=/"},this.remove=function(d){d=a+d;var e=new Date;e.setTime(e.getTime()-1);e="; expires="+e.toGMTString();document.cookie=d+"= "+e+"; path=/"})};
